4.6 条件随机场模型

条件随机场（Conditional Random Fields, CRF）最早由Lafferty等人于2001年提出，其模型思想的主要来源是隐马尔科夫模型。

对HMM模型的三个基本问题的解决用到了HMM模型中提到的方法如Forward-Backward算法和Viterbi算法。可以把条件随机场看成一个无向图模型或马尔科夫随机场，它是一种用来标记和切分序列化数据的统计模型。该模型是在给定需要标记的观察序列的条件下，计算整个标记序列的联合概率，而不是在给定当前状态的条件下，定义下一个状态的分布。标记序列（Label Sequence）的分布条件属性，可以让CRF很好地拟和现实数据，而在这些数据中，标记序列的条件概率信赖于观察序列中非独立的、相互作用的特征，并通过赋予特征以不同权值来表示特征的重要程度。

下文说明了条件随机场的思想和理论基础。首先，给出条件随机场的通用公式，接着深入讨论CRF最普遍的形式，具有线性序列的结构。主要的重点是训练和推理方面。本节以简短的内容讨论了任意结构的CRF。

### 4.6.1 随机场

随机场是一个随机过程的推广，使得底层的参数不再是一个简单的实数或整型“时间”，而是一个多维向量或点。在离散的情况下，随机场可以被认为是一组被确定在某个空间（如n维欧几里得空间）的离散点（随机数）列表。在统计学中，随机场可以看成一组随机变量的集合，而这组随机变量对应同一个样本空间。当然，这些随机变量之间常有某种依赖关系，一般来说，也只有当这些变量之间有依赖关系的时候，我们将其单独拿出来看成一个随机场才有实际意义。

因此，确定一个随机场有如下重要的要素。第一，随机过程包含了哪些不同的样本空间；第二，样本空间中的随机变量相互之间形成何种依赖关系（换个角度讲，就是条件独立的关系）。这两个因素是构成“随机场”的基本要件。

随机场包含如下两个要素：样本空间集合和单个样本空间中的随机变量集合。

我们不妨拿种地来打个比方。“不同分布的样本空间”好比一亩亩农田；“相互依赖的随机变量”好比种的各种庄稼。我们可以给不同的地种上不同的庄稼，这就好比给随机场的每个“样本空间”里赋予不同取值范围的随机变量。通俗一点地讲，随机场就是在哪块地里种什么庄稼的事情。

随机场（Random Field）定义如下：在概率论中，由样本空间Ω = {0, 1, …, G-1}n取样构成的随机变量Xi所组成的S= {X1, …, Xn}。若对所有的ω∈Ω, π(ω) > 0。则称π为一个随机场。一些已有的随机场，如吉布斯随机场（GRF）、马尔科夫随机场（MRF）、条件随机场（也常被称为马尔科夫随机场，CRF）和高斯随机场。

所以，求解一个随机场，就是要找到有多少种不同的样本空间，以及其中随机变量的概率分布。

### 4.6.2 无向图的团（Clique）与因子分解

引入团的定义：无向图G的某个子图S，若S中的任何两个节点均有边，则S称为G的团（Clique）。

若C是G的一个团，并且不能再加入任何一个G的节点使其称为团，则称C为G的最大团（Maximal Clique）。举例如下。

图4.15中的团包括如下内容。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784638442-0a464dfb-fdd1-4415-9355-e7b6430c1f5c.jpeg)

图4.15 无向图的团

{1,2}, {1,3}, {2,3}, {2,4}, {3,4}, {3,5}, {1,2,3}, {2,3,4}。

其中，最大团包括：{1,2,3}, {2,3,4}, {3,5}。

对于一个无向图而言，其联合分布可以表示成最大团上的随机变量函数的乘积形式，这个操作称为无向图的因子分解（Factorization）。

如图4.15所示，其因子分解可以表示为如下形式。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784638649-2af04a8a-cf52-4070-9249-72f0e68153fd.jpeg)

因为，p(y|θ)是一个取值为0～1的概率，Z(θ)为归一化因子。

将其统一形式化为如下公式，下式称为Hammersley-Clifford定理。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784638933-1b070551-0643-4b80-aea2-2a0b1e485273.jpeg) （4.6.1）

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784639179-42789209-79e4-4728-8948-f70e40eb9abd.jpeg) （4.6.2）

其中，C是G上的最大团集合，ψC(YC)是C上定义的严格正函数，这就是我们常说的势函数（Potential Function）。因子分解是在无向图上所有的最大团上进行的。

### 4.6.3 线性链条件随机场

条件随机场定义：设X=(X1, X2, …, Xn)和Y=(Y1, Y2, …, Ym)都是联合随机变量，若随机变量Y构成一个无向图G=(V, E)表示的马尔科夫随机场（MRF），则其条件概率分布P(Y|X)称为条件随机场（Conditional Random Field, CRF），即P(Yv|X, Yw,w≠v)=P(Yv|X, Yw,w≈v)。其中，w≈v表示与节点v相连的所有节点w。

目前自然语言处理中，最常用的是线性链条件随机场（Linear Chain Conditional Random Field）。此时，条件概率P(Y|X)中，Y表示标记序列（或状态序列）, X是被标注的观测序列。

如图4.16所示，线性链条件随机场定义：设X=(X1,X2, …,Xn)和Y=(Y1,Y2, …,Yn)均为线性链表示的随机变量序列，若在给定的随机变量序列X的条件下，随机变量序列Y的条件概率分布P(Y|X)构成条件随机场，即满足马尔科夫性：

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784639515-eb7a86a3-ab1e-4b8a-a7a0-4b1dd0fe3dc1.jpeg)

图4.16 无向图的条件随机场模型

P(Yi| X, Y1, Y2, …, Yn) = P(Yi| X, Yi-1, Yi+1)

则称P(Y|X)为线性链的条件随机场。在自然语言的标注问题中，Y表示标记序列（或状态序列）, X表示输入序列或观测序列。

线性链条件随机场的参数化形式如下。

设P(Y|X)为线性链条件随机场，则在随机变量X取值为x的条件下，随机变量Y取值为y的条件概率有如下形式。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784639870-105a4582-ad08-4ed8-8514-7de54210207f.jpeg) （4.6.3）

其中，归一化因子Z(x)为

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784640556-a0c44f42-27d6-4865-9caf-81e5af0aee73.jpeg) （4.6.4）

需要注意的是，这里的式（4.6.3）与式（4.6.1）是等价的，式（4.6.4）与式（4.6.2）也等价。函数之所以做出这样的变形，是因为任何一个形如：

Y=a ·X1·X2·…·Xn

的正函数（其中，∀a, Xi, Y >0, Xi∈Xn），都可以写成形如：

Y=exp(log(a)+log(X1)+log(X2)+…+log(Xn))

的形式，函数没有发生任何变化，但是参数Xn间的相乘关系变为相加关系。这是为了后面推导和寻优方便。

上式中，λk和μl是对应的权值。tk和sl是特征函数，这里详细讲解一下特征函数，i表示y的所有可能取值，k和l表示特征函数的个数。其中，tk(yi-1, yi, x, i)中的yi-1, yi, x三个节点构成线性链上的最大团，sl(yi, x, i)表示不同x标注为yi的概率。

综上所述，总结出条件随机场的参数如下。

❑ tk是定义在(yi-1, yi, x)边上的特征函数，称为转移特征，依赖于当前和前一个位置。当然也可以是后面的位置。sl是定义在(yi, x)上的特征函数，称为状态特征，仅依赖于当前的位置。

❑ tk和sl都依赖于局部位置，称为局部特征函数。

❑ 通常，tk和sl的取值为1、0；满足特征条件时取1，否则取0。下面以tk为例说明特征函数的取值情况。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784641199-3a40649d-0d09-49ca-a4f1-38922096b41a.jpeg)

sl的取值情况与此相同。

❑ CRF完全由特征函数tk、sl，以及与之相对应的权值λk和μl确定。

❑ 线性链条件随机场的函数使用了对数变换，因此称这种变换后的模型为对数线性模型。

上式有些复杂，不便于推导，为了表示方便，将其逐步简化。

（1）tk和sl都依赖于局部位置，为方便起见，可以将转移特征和状态特征及其权值用统一的符号表示。

设有K1个转移特征，有K2个状态特征，k=K1+K2，则：

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784642040-8519693f-f0b4-434b-aa42-85c0e9098ed6.jpeg)

对上式进一步简化：

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784642651-f1c2fed2-6fc3-426f-b008-3036da8f785b.jpeg) （4.6.5）

（2）用w来表示统一的权重λk和μl。

w={w1, w2, …, wK}

（3）简化后的CRF可以表示为如下形式。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784643094-db4eea5d-38a6-433d-93ab-e5cf2a422a63.jpeg) （4.6.6）

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784643821-017636ba-5fbf-49a6-ac27-4b1e9585646d.jpeg) （4.6.7）

（4）将f(y, x)写成向量的形式。

F(y, x)={f1(y, x), f2(y, x), …, fK(y, x)}

（5）CRF可以写成形式向量内积的形式。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784644256-0d837f26-1289-43de-be33-dfad8a2278f7.jpeg) （4.6.8）

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784644779-3d51f0f4-f2b2-457f-9f3e-ab7dbe9bfb23.jpeg) （4.6.9）

（6）CRF的矩阵形式如下。

引入起始、终止节点标记。

① y0=start, yn+1=stop。

start和stop为标记空间的某两个值。

② 定义m阶矩阵（m是标记yi取值的个数）。

Mi(x)+[Mi(yi-1, yi|x)]

Mi(yi-1, yi|x)+exp(Wi(yi-1, yi|x))

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784645315-0a7e04fe-cf93-4487-a14e-8d15b426f767.jpeg)

此时，条件概率p(y|x)就变成：![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784645755-080f742a-c241-48d5-be07-ed40de26d1d6.jpeg)

其中，Z(x)是归一化因子：Zw(x)=(M1(x)M2(x)…Mn+1(x))start, stop

y0=start, yn+1=stop表示开始和终止状态，是以start为起点、stop为终点通过状态y1, y2, …, yn为所有路径的非规范化概率之和，也是矩阵连乘M+1次后得到的新矩阵（start, end）位置的元素值。

### 4.6.4 CRF的概率计算

给定条件随机场P(Y|X)，输入序列x和输出序列y，使用前向、后向算法都到计算的P(Yi=y|x)和P(Yi-1=yi-1, Yi=yi|x)。

（1）前向向量。

定义αi(yi|x)：输入序列位置i的标记是yi，并且到位置i之前部分标记序列的非归一化概率。如果yi可取的值有m个，αi(yi|x)是m维列向量，则

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784646246-df584281-5cd8-4c6c-9167-9c7249f462b3.jpeg)

（2）后向向量。

定义βi(yi|x)：输入序列位置i的标记是yi，并且到位置i+1到n之后部分标记序列的非归一化概率。如果yi可取的值有m个，βi(yi|x)是m维列向量，则

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784646771-01a90b9f-529a-476a-90ba-faef7a30edf7.jpeg)

βi(yi|x)+Mi(yi, yi+1|x)βi+1( yi+1|x) i=1,2,…,n+1

βi(x)+Mi+1(x)βi+1(x)

（3）计算归一化因子Z(x)。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784647057-de0b5827-cad6-44aa-b0ed-8ae227b25ff9.jpeg)

（4）计算P(Yi=y|x)和P(Yi-1=yi-1, Yi=yi|x)。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784647324-b4742931-7447-415d-a9a5-637d1e988a51.jpeg) （4.6.10）

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784647887-b44c8da1-750d-4f2a-a42c-f4e2caf8c2d7.jpeg) （4.6.11）

### 4.6.5 CRF的参数学习

根据训练数据集合(x, y)，可以求出经验概率分布P(x, y)，然后使用极大似然估计给出目标函数。这里未知数是w。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784649664-c8cf401e-2d5e-4d66-8645-545005cbd4dd.jpeg) （4.6.12）

通过似然函数w变量的下界，给定学习速率δ，通过迭代法寻求最优的参数w。

w=(w1, w2, …, wK)T

δ=(δ1, δ2, …, δK)T

w+δ= (w1+δ1, w2+δ2, …, wK+δK)T

经过计算，转移特征tk的更新方程为

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784650146-c1ac26e8-e808-4fbf-a82b-0b4a7b9cee70.jpeg) （4.6.13）

状态特征sl的更新方程为：

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784650669-8205fb49-5841-45e1-a333-d66c82600a66.jpeg) （4.6.14）

其中，T (x, y)为在数据(x, y)中出现的所有特征数之和。

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784651185-f6e59fd9-b808-4fd8-9d25-6b65955bd99f.jpeg)

当前转移特征tk和状态特征sl给定的条件下，求关于未知向量δ。取所有T(x, y)的最大值S，并用S代替其他T(x, y)，则上式可直接给出如下解析式：

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784651532-832ee145-c23c-412a-8377-0eca37d9efc0.jpeg)

其中，

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784652034-2b651a39-b13e-4608-b93e-e3863135cecb.jpeg)

为了追求更高的精度，常常使用基于拟牛顿法的L-BFGS等方法计算得到δ。第5章讲解的CRF++框架就是使用L-BFGS方法训练出模型的参数。

### 4.6.6 CRF预测标签

给定条件随机场P(Y|X)和输入序列x，求条件概率最大的输出序列（标记序列）y*，即对观测序列进行标注。这一过程仍旧使用HMMs的Viterbi算法。

优化目标函数：

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784652593-07b8d192-7e5f-4058-9f67-ed98b43a21b0.jpeg)

推导之后可知，CRF的预测问题就是非规范化概率最大的最优路径问题。

其中，

w={w1, w2, …, wK}

F(y, x)={ f1(y, x), f2(y, x), …, fK(y, x)}

![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784653214-1e6b333d-d123-424c-8bf9-846c17cbbcab.jpeg)

根据Viterbi算法，位置i的各个标记l=1,2, …, m的非规范化概率的最大值。

（1）起始位置的概率计算：δ1=w. F1(y0=start, y1=l, x), l= 1,2, …

,m。

（2）中间位置的概率计算：![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784653686-e5e766ae-5ee4-4fb7-b353-0280c95eff1c.jpeg)。

（3）最优路径：![img](https://cdn.nlark.com/yuque/0/2021/jpeg/21473765/1631784654142-6a103684-2c1f-4bef-9a0d-472657624012.jpeg)。
